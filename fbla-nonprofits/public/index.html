<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Nonprofits Near You</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; display: grid; grid-template-columns: 360px 1fr; height: 100vh;}
    header { grid-column: 1 / -1; padding: 10px 16px; border-bottom: 1px solid #eee; font-weight: 700; }
    #left { overflow: auto; padding: 12px; border-right: 1px solid #eee; }
    #map { height: calc(100vh - 48px); }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px;}
    .muted { color: #666; font-size: 12px; }
    .row { display:flex; gap:8px; margin-bottom:8px;}
    input, select, button { padding:8px; border:1px solid #ccc; border-radius:8px; }
  </style>
</head>
<body>
  <header>FBLA Nonprofits Finder (Offline-friendly)</header>
  <div id="left">
    <div class="row">
      <input id="q" placeholder="Search (name/cause/needs)" style="flex:1" />
    </div>
    <div class="row">
      <input id="state" placeholder="State (e.g., KY)" style="width:100px" />
      <input id="minRating" type="number" step="0.1" min="0" max="5" placeholder="Min rating" style="width:120px" />
      <button id="searchBtn">Search</button>
    </div>
    <div class="row">
      <input id="lat" placeholder="Lat" style="width:120px" />
      <input id="lng" placeholder="Lng" style="width:120px" />
      <input id="radius" placeholder="Radius km" style="width:120px" value="25" />
      <button id="nearBtn">Near</button>
    </div>
    <div id="list"></div>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script>
    const API = "http://localhost:8080";
    const map = L.map('map').setView([38.2527, -85.7585], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let markers = [];

    function renderList(items) {
      const list = document.getElementById('list');
      list.innerHTML = "";
      // clear markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      items.forEach(o => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div><strong>${o.name}</strong></div>
          <div class="muted">${o.cause || ''} • ${o.city || ''}, ${o.state || ''}</div>
          <div class="muted">Needs: ${o.needs || '—'}</div>
          <div class="muted">Rating: ${o.rating ?? '—'}</div>
          <div><a href="${o.website || '#'}" target="_blank">${o.website || ''}</a></div>
          <div class="muted">${o.phone || ''}</div>
        `;
        list.appendChild(card);

        if (o.lat && o.lng) {
          const m = L.marker([o.lat, o.lng]).addTo(map)
            .bindPopup(`<b>${o.name}</b><br>${o.cause || ''}<br>${o.city || ''}, ${o.state || ''}`);
          markers.push(m);
        }
      });

      if (items.some(o => o.lat && o.lng)) {
        const pts = items.filter(o=>o.lat && o.lng).map(o => [o.lat, o.lng]);
        const bounds = L.latLngBounds(pts);
        map.fitBounds(bounds.pad(0.2));
      }
    }

    async function search() {
      const q = document.getElementById('q').value.trim();
      const state = document.getElementById('state').value.trim();
      const minRating = document.getElementById('minRating').value.trim();
      const params = new URLSearchParams({ q, state, minRating });
      const res = await fetch(`${API}/orgs?${params.toString()}`);
      const data = await res.json();
      renderList(data);
    }

    async function near() {
      const lat = document.getElementById('lat').value.trim();
      const lng = document.getElementById('lng').value.trim();
      const radiusKm = document.getElementById('radius').value.trim() || "25";
      if (!lat || !lng) { alert("Enter lat & lng"); return; }
      const params = new URLSearchParams({ lat, lng, radiusKm });
      const res = await fetch(`${API}/near?${params.toString()}`);
      const data = await res.json();
      renderList(data);
    }

    document.getElementById('searchBtn').onclick = search;
    document.getElementById('nearBtn').onclick = near;

    // initial load
    search();
  </script>
</body>
</html>
